<!DOCTYPE html>
<html lang="ch" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Graph Tool</title>
    <link th:href="@{favicon.ico}" rel="shortcut icon">
    <link th:href="@{/css/bootstrap.min.css?v=3.3.6}" rel="stylesheet">
    <link th:href="@{/css/font-awesome.css?v=4.4.0}" rel="stylesheet">
    <link th:href="@{/css/plugins/iCheck/custom.css}" rel="stylesheet">
    <link th:href="@{/css/animate.css}" rel="stylesheet">
    <link th:href="@{/css/multiple-select.min.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/css/GA.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/css/style.css?v=4.1.0}" rel="stylesheet">
    <link th:href="@{https://cache.amap.com/lbs/static/main1119.css}" rel="stylesheet"/>
    <style>
        .amap-icon img,
        .amap-marker-content img {
            width: 25px;
            height: 34px;
        }

        .marker {
            position: absolute;
            top: -20px;
            right: -118px;
            color: #fff;
            padding: 4px 10px;
            box-shadow: 1px 1px 1px rgba(10, 10, 10, .2);
            white-space: nowrap;
            font-size: 12px;
            font-family: "";
            background-color: #25A5F7;
            border-radius: 3px;
        }

        /*标题*/
        /*.ibox-title {*/
        /*    height: 200px;*/
        /*    border-color: #edf1f2;*/
        /*    background-color: #dbeafe;*/
        /*    color: black;*/
        /*    display: flex;*/
        /*    align-items: center;*/
        /*    justify-content: center;*/
        /*}*/

        .ibox-title span {
            font-size: 50px;
        }

        /*#submit {*/
        /*    background-color: #347aa9;*/
        /*    padding: 5px 20px;*/
        /*    cursor: pointer;*/
        /*    color: black;*/
        /*    font-size: 20px;*/
        /*    display: inline-block;*/
        /*    text-align: center;*/
        /*    !*margin-right: 50px;*!*/

        /*}*/

        .btn2 {
            line-height: 30px;
            text-align: center;
            display: flex;
            justify-content: center;
        }

        /*选择框居中*/
        .midtile {
            line-height: 30px;
            text-align: center;
            display: flex;
            justify-content: center;
        }

        /*上传按钮*/
        .upload-btn {
            background-color: #347aa9;
            color: white;
            cursor: pointer;
            padding: 5px 20px;
            text-align: center;
            font-size: 20px;
            display: inline-block;
            margin: 30px;
        }

        #pre {
            text-align: center;
        }

        #pre img {
            display: inline-block;
            max-width: 50%;
            height: auto;
        }

        #after {
            text-align: center;
        }

        #after img {
            display: inline-block;
            max-width: 50%;
            height: auto;
        }

        .tabs-container ul {
            height: 50px;
            display: flex;
            flex-direction: row;
            justify-content: center;
        }
    </style>
    <!--    <script type="text/javascript">-->
    <!--        window._AMapSecurityConfig = {-->
    <!--            securityJsCode: "919c4ab28e79692cb9fac5abcb3ae1b0",-->
    <!--        };-->
    <!--    </script>-->

    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: "120a27c95fe9d758fa109e700d2bfb97",
        };
    </script>
    <!-- 全局js -->
    <script th:src="@{/js/jquery.min.js?v=2.1.4}"></script>
    <script th:src="@{/js/bootstrap.min.js?v=3.3.6}"></script>
    <script th:src="@{/js/xlsx.full.min.js}"></script>

    <!--    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=9017e2042639d8873323dcd7d7539611&plugin=AMap.PlaceSearch"></script>-->
    <script type="text/javascript"
            th:src="@{https://webapi.amap.com/maps?v=1.4.15&key=3ec301cfc0baed14e8a4c2d1b61b1706&plugin=AMap.PlaceSearch}"></script>
    <script th:src="@{https://cache.amap.com/lbs/static/addToolbar.js}" type="text/javascript"></script>

    <!-- Bootstrap table -->
    <script th:src="@{/js/plugins/bootstrap-table/bootstrap-table.min.js}"></script>
    <script th:src="@{/js/plugins/bootstrap-table/bootstrap-table-mobile.min.js}"></script>
    <script th:src="@{/js/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.min.js}"></script>

    <!-- Peity -->
    <script th:src="@{/js/plugins/peity/jquery.peity.min.js}"></script>
    <script th:src="@{/js/plugins/layer/layer.min.js}"></script>
    <script th:src="@{/js/multiple-select.min.js}"></script>
    <!-- 自定义js -->
    <script th:src="@{/js/content.js?v=1.0.0}"></script>
    <script type="text/javascript">
        const default_marker_image = "https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png";

        window.onload = function () {
            document.getElementById("fileUpload").addEventListener("change", choose_file)
            document.getElementById("encryptGraph").addEventListener("click", function () {
                // 获取输入文本
                let inputText = document.getElementById("textInput").value;

                fetch("/Encrypt/desenGraph", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: '&rawData=' + encodeURIComponent(inputText)

                })
                    .then(response => {
                        if (response.status === 500) {
                            // Handle server error
                            return response.text().then(failedMsg => {
                                alert(failedMsg);
                                throw new Error(failedMsg); // Throw an error to stop further processing
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById("outputText").value = data.message.result;
                        // 获取data.message中的值
                        let encryptedMessage = data.message.kdTree;
                        // 创建一个blob对象，将数据存入blob
                        let blob = new Blob([encryptedMessage], {type: 'text/plain'});
                        // 创建一个链接对象
                        let link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        // 设置下载文件的名字
                        link.download = Date.now() + 'KDTree.txt';
                        // 触发点击事件下载文件
                        link.click();
                        // 释放URL对象
                        window.URL.revokeObjectURL(link.href);
                    })
                    .catch(error => console.error('Error:', error));

            })

        }

        function initMap() {
            let lnglat = new AMap.LngLat(116.326936, 40.003213);
            let map = new AMap.Map("mapid", {
                resizeEnable: true,  // 自适应地图容器变化
                center: lnglat,      // 地图中心点坐标
                key: "3ec301cfc0baed14e8a4c2d1b61b1706",
                /* key:"a356710cf98fab9a753bceb3f2dc3c96",*/
                viewMode: '3D',   // 地图显示模式，'3D' 表示三维地图
                /*  showBuildingBlock: true, // 是否显示楼块
                  showIndoorMap: true,  // 是否显示室内地图
                  pitch: 45,              // 地图俯仰角度，单位为度，范围 [0, 60]
                  rotation: 10,           // 地图旋转角度，单位为度，范围 [0, 360]*/
                willReadFrequently: true, //
                zoom: 10
            });
            return map;
        }

        // function displayTrack(e, map, outlineColor = '#f50b0b', strokeColor = 'red', markerImage = default_marker_image, windowContent = "原始轨迹") {
        //     const content = e.target.result;
        //
        //     // 使用PlaceSearch类来获取POI信息
        //     const placeSearch = new AMap.PlaceSearch({
        //         /* city: 'beijing', // 兴趣点城市*/
        //         pageSize: 1,
        //         pageIndex: 1,
        //         children: 0, //不展示子节点数据
        //         extensions: 'base' //返回基本地址信息
        //         //map: map
        //     });
        //     // 将文件内容分割成行
        //     const lines = content.split('\n');
        //     console.log("Total line number:" + lines.length);
        //     let index = Math.floor(Math.random() * lines.length);
        //     console.log("Line index: " + index);
        //     // 随机获取一行数据
        //     let raw_line = lines[index];
        //     console.log("Line:", raw_line);
        //     // 分割原始轨迹每个点
        //     let raw_points = raw_line.split(';');
        //     // 去除数组中的空字符串元素
        //     raw_points = raw_points.filter(item => item.trim() !== '');
        //     console.log("raw_points length: " + raw_points.length);
        //     // 保存原路径节点经纬度
        //     let raw_path = []
        //
        //     let promises = raw_points.map(point => {
        //         return new Promise((resolve, reject) => {
        //             let [poiId, attributes] = point.split(',');
        //             placeSearch.getDetails(poiId, function (status, result) {
        //                 if (status === 'complete' && result.info === 'OK') {
        //                     // if (result.poiList.pois && result.poiList.pois.length > 0) {
        //                     //     let location = result.poiList.pois[0].location;
        //                     //     console.log(result.poiList.pois[0])
        //                     //     console.log(location.lng + " " + location.lat)
        //                     //     resolve([location.lng, location.lat]);
        //                     // } else {
        //                     //     console.log("选取的该行POI没有位置数据");
        //                     //     reject("选取的该行POI没有位置数据");
        //                     // }
        //                     let location = result.poiList.pois[0].location;
        //                     console.log(result.poiList.pois[0])
        //                     console.log(location.lng + " " + location.lat)
        //                     resolve([location.lng, location.lat]);
        //
        //                 } else {
        //                     console.log("获取POI信息失败，POI ID:" + poiId);
        //                 }
        //             });
        //         });
        //     });
        //
        //     // 使用Promise.all等待所有的Promise都完成
        //     Promise.all(promises).then(raw_path => {
        //         for (let [lng, lat] of raw_path) {
        //             let marker = new AMap.Marker({
        //                 icon: markerImage,
        //                 position: [lng, lat],
        //                 offset: new AMap.Pixel(-13, -30)
        //             });
        //             marker.setMap(map)
        //         }
        //
        //         // 创建折线实例
        //         let polyline = new AMap.Polyline({
        //             path: raw_path,         // 折线的路径，`desen_path` 应该是包含经纬度坐标的数组
        //             isOutline: true,         // 是否显示折线的轮廓线
        //             outlineColor: outlineColor, // 轮廓线颜色
        //             borderWeight: 1,         // 轮廓线宽度
        //             strokeColor: strokeColor,     // 折线颜色
        //             strokeOpacity: 1,        // 折线透明度，范围 [0, 1]
        //             strokeWeight: 6,         // 折线宽度
        //             strokeStyle: "solid",    // 折线样式，可选值："solid"（实线）、"dashed"（虚线）、"dotted"（点线）
        //             strokeDasharray: [10, 5], // 虚线样式，数组中的数字表示虚线和空白段的长度
        //             lineJoin: 'round',       // 折线交汇处的连接方式，可选值："round"、"bevel"、"miter"
        //             lineCap: 'round',        // 折线两端的线帽样式，可选值："butt"、"round"、"square"
        //             zIndex: 50,              // 折线的层级
        //         });
        //
        //         // 将折线添加至地图实例
        //         polyline.setMap(map);
        //         // 选择折线的第一个点作为信息窗体的位置
        //         let infoWindowPosition = raw_path[0];
        //         // 创建信息窗体
        //         let infoWindow = new AMap.InfoWindow({
        //             content: windowContent,
        //             position: infoWindowPosition,
        //             isCustom: true,
        //             autoMove: true,
        //         });
        //
        //         // 打开信息窗体
        //         infoWindow.open(map, infoWindowPosition);
        //
        //         // ...其他代码
        //     }).catch(error => console.error('Error:', error));
        // }

        function displayTrack(e, map, outlineColor = '#f50b0b', strokeColor = 'red', markerImage = default_marker_image, windowContent = "原始轨迹") {
            const content = e.target.result;
            const maxAttempts = 50; // 设置最大查询次数
            let attemptCount = 0; // 记录当前查询次数

            // 使用PlaceSearch类来获取POI信息
            const placeSearch = new AMap.PlaceSearch({
                pageSize: 1,
                pageIndex: 1,
                children: 0, // 不展示子节点数据
                extensions: 'base' // 返回基本地址信息
            });

            // 将文件内容分割成行
            const lines = content.split('\n');
            console.log("Total line number:" + lines.length);

            function processRandomLine() {
                attemptCount++; // 每次调用时增加一次计数

                if (attemptCount > maxAttempts) {
                    // 达到最大尝试次数时，弹窗提示用户
                    alert("已超过最大尝试次数，无法找到合适的POI数据。");
                    return; // 超过最大尝试次数时停止递归
                }

                let index = Math.floor(Math.random() * lines.length);
                console.log("Line index: " + index);

                // 随机获取一行数据
                let raw_line = lines[index];
                console.log("Line:", raw_line);

                // 分割原始轨迹每个点
                let raw_points = raw_line.split(';').filter(item => item.trim() !== '');
                console.log("raw_points length: " + raw_points.length);

                // 保存原路径节点经纬度
                let raw_path = [];

                // 使用 Promise.all 来检查所有 POI 点是否都能解析
                let promises = raw_points.map(point => {
                    return new Promise((resolve, reject) => {
                        let [poiId, attributes] = point.split(',');
                        placeSearch.getDetails(poiId, function (status, result) {
                            if (status === 'complete' && result.info === 'OK') {

                                // let location = result.poiList.pois[0].location;
                                // console.log(result.poiList.pois[0]);
                                // console.log(location.lng + " " + location.lat);
                                // resolve([location.lng, location.lat]);
                                if (result.poiList.pois && result.poiList.pois.length > 0) {
                                    let location = result.poiList.pois[0].location;
                                    console.log(result.poiList.pois[0])
                                    console.log(location.lng + " " + location.lat)
                                    resolve([location.lng, location.lat]);
                                } else {
                                    console.log("选取的该行POI没有位置数据");
                                    reject("选取的该行POI没有位置数据");
                                }
                            } else {
                                console.log("获取POI信息失败，POI ID:" + poiId);
                                reject("选取的POI没有位置数据"); // 如果失败，reject
                            }
                        });
                    });
                });

                // 处理所有的 Promise
                Promise.all(promises).then(raw_path => {
                    // 所有 POI 点都解析成功，开始在地图上绘制
                    for (let [lng, lat] of raw_path) {
                        let marker = new AMap.Marker({
                            icon: markerImage,
                            position: [lng, lat],
                            offset: new AMap.Pixel(-13, -30)
                        });
                        marker.setMap(map);
                    }

                    // 创建折线实例
                    let polyline = new AMap.Polyline({
                        path: raw_path,         // 折线的路径
                        isOutline: true,        // 是否显示折线的轮廓线
                        outlineColor: outlineColor, // 轮廓线颜色
                        borderWeight: 1,        // 轮廓线宽度
                        strokeColor: strokeColor,   // 折线颜色
                        strokeOpacity: 1,       // 折线透明度
                        strokeWeight: 6,        // 折线宽度
                        strokeStyle: "solid",   // 折线样式
                        strokeDasharray: [10, 5], // 虚线样式
                        lineJoin: 'round',      // 折线交汇处的连接方式
                        lineCap: 'round',       // 折线两端的线帽样式
                        zIndex: 50,             // 折线的层级
                    });

                    // 将折线添加至地图实例
                    polyline.setMap(map);

                    // 选择折线的第一个点作为信息窗体的位置
                    let infoWindowPosition = raw_path[0];
                    let infoWindow = new AMap.InfoWindow({
                        content: windowContent,
                        position: infoWindowPosition,
                        isCustom: true,
                        autoMove: true,
                    });

                    // 打开信息窗体
                    infoWindow.open(map, infoWindowPosition);
                }).catch(error => {
                    // 如果解析失败，递归重新选择一行数据
                    console.error('Error:', error);
                    processRandomLine(); // 重新选择一行数据
                });
            }

            // 初始调用
            processRandomLine();
        }

        function choose_file(event, map) {
            // 清空
            document.getElementById("fileInfo").innerHTML = "";
            //读取文件
            const file = event.target.files[0]

            // 文件名，扩展名
            if (file) {
                const fileName = file.name;
                let fileLoad = "<div  style=\"font-size: 15px; text-align: center\"> <span>" +
                    "<strong>" + fileName + "文件</strong>已选择" + "</span>" + "</div>";
                console.log(fileName)
                document.getElementById("fileInfo").innerHTML = fileLoad
                const fileExtension = fileName.split('.').pop().toLowerCase();
                console.log(fileExtension)

                // 读取文件内容绘制原轨迹

                // 初始化map
                let map = initMap();

                //绘制原轨迹
                const reader = new FileReader();
                reader.onload = function (e) {
                    displayTrack(e, map)
                };
                reader.readAsText(file);


                /*if(graphType.includes(fileExtension)){*/
                //提交脱敏参数，请求脱敏
                document.getElementById("submit").onclick = function () {
                    // 获取保护级别
                    let selections = document.getElementById("privacyLevel-selections")
                    let param = selections.value;

                    let formData = new FormData();
                    formData.set("file", file);
                    formData.set("params", param);
                    formData.set("algName", "dpGraph")

                    let idx = $("ul .active").index();
                    if (idx === 0) {
                        formData.set("distortion", "distortion");
                        let distortionAlgs = document.getElementById("distortion-algs")
                        let type1 = distortionAlgs.value;
                        formData.set("sheet", type1);
                    }
                    // else {
                    //     formData.set("distortion", "nodistortion");
                    //     table_body = document.getElementById("table2")
                    //     tr = table_body.rows[0];
                    //     let type2 = tr.childNodes[0].firstChild.value;
                    //     formData.set("sheet", "nodistortion");
                    // }

                    fetch('/File/desenFile', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => {
                            if (response.status === 500) {
                                // Handle server error
                                return response.text().then(failedMsg => {
                                    alert(failedMsg);
                                    throw new Error(failedMsg); // Throw an error to stop further processing
                                });
                            }
                            // console.log(response.headers.get('Content-Disposition'));
                            // let fileName = response.headers.get('Content-Disposition').split('filename=')[1].split(';')[0];
                            // fileName = fileName.replaceAll('"', '')
                            // console.log(fileName);
                            // return response.blob().then(blob => ({ blob, fileName }));  // If the status is not 500, proceed to handle the file blob
                            return response.blob();
                        })
                        .then(blob => {
                            // 创建一个新的FileReader对象
                            const desen_reader = new FileReader();
                            //处理后的轨迹
                            let desen_line;
                            // 读取返回的Blob数据
                            desen_reader.onload = function (e) {
                                displayTrack(e, map, '#49ff00', 'green', default_marker_image, "脱敏后轨迹")
                            };
                            // 将Blob数据传递给FileReader
                            desen_reader.readAsText(blob);

                            // 创建一个下载链接
                            const downloadLink = document.createElement('a');
                            downloadLink.href = URL.createObjectURL(blob);
                            downloadLink.download = "graph" + Date.now().toString() + ".txt"; // 下载的文件名
                            downloadLink.click();
                            // 释放URL对象
                            URL.revokeObjectURL(downloadLink.href);

                        })
                        .catch(error => console.error('Error:', error));

                }

            }
        }

    </script>
</head>
<body>
<div class="wrapper wrapper-content">
    <div class="row">
        <div class="col-lg-12">
            <div class="tabs-container">
                <ul id="tab-type" class="nav nav-tabs" style="left: 50%;font-size: 20px;">
                    <li class="active"><a data-toggle="tab" href="#tab-1" aria-expanded="true"> 失真 </a>
                    </li>
                    <li class=""><a data-toggle="tab" href="#tab-2" aria-expanded="false"> 非失真 </a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div id="tab-1" class="tab-pane active" style="text-align: center;">
                        <div class="panel-body">
                            <form role="form" class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-lg-3 col-lg-offset-3 control-label" for="distortion-algs">
                                        请选择图形失真脱敏算法
                                    </label>
                                    <div class="col-lg-2">
                                        <select class=" form-control" name="distortion-algs" id="distortion-algs">
                                            <option value="dp" selected> 差分算法</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-lg-3 col-lg-offset-3 control-label" for="privacyLevel-selections">
                                        请选择隐私保护等级
                                    </label>
                                    <div class="col-lg-2">
                                        <select class=" form-control" name="privacyLevel-selections"
                                                id="privacyLevel-selections">
                                            <option value="0"> 低程度</option>
                                            <option value="1" selected> 中程度</option>
                                            <option value="2"> 高程度</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group text-center">
                                    <input type="file" id="fileUpload" accept=".txt" style="display: none;">
                                    <label for="fileUpload" class="btn btn-white">
                                        选择文件
                                    </label>
                                </div>
                                <div id="fileInfo">
                                </div>
                                <div class="form-group text-center">
                                    <button type="button" class="btn btn-primary" id="submit"> 提交脱敏</button>
                                </div>
                            </form>


                            <div class="row">
                                <div class="col-lg-12">
                                    <div id="mapid" style="height: 1000px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="tab-2" class="tab-pane">
                        <div style="text-align: center; font-size: 20px; margin-top: 20px;">
                            <input type="text" id="textInput" placeholder="输入整数数值时间序列，以,分隔">
                            <button id="encryptGraph">提交</button>
                            <br>
                            <p>返回相似的序列ID</p>
                            <textarea id="outputText" rows="4" cols="50" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
